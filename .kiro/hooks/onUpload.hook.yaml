# AUTO-GENERATED BY KIRO
# Hook: onUpload Event

event: "onUpload"
trigger: "User uploads fabric images (top, bottom, trims, or reference model)"
files_affected:
  - "client/src/components/FabricUploader.tsx"
  - "server/fusion.ts"
  - "server/faceProtect.ts"

actions:
  - name: "upload_to_cloudinary"
    description: "Upload image to Cloudinary"
    code_location: "server/fusion.ts:uploadImages"
    provider: "cloudinary"
    folder: "fusion/uploads"
    
  - name: "detect_faces"
    description: "Detect faces in uploaded images"
    code_location: "server/faceProtect.ts:detectFaces"
    providers:
      - "huggingface" # damo/retinaface
      - "bytez" # fallback
      - "cloudinary" # fallback
    review_required: true  # Face detection policy
    
  - name: "check_consent"
    description: "Check if user consented to face masking"
    code_location: "server/faceProtect.ts:checkFaceProtection"
    requires_consent: true
    
  - name: "update_ui"
    description: "Update UI with upload status and face detection notice"
    code_location: "client/src/components/FabricUploader.tsx:handleUpload"
    state_updates:
      - "fabricTop/fabricBottom/fabricTrims/referenceModel": "Cloudinary URL"
      - "faceDetected": "boolean"
      - "uploading": "string | null"

outputs:
  - "imageUrl": "Cloudinary secure URL"
  - "faceDetected": "boolean"
  - "requiresConsent": "boolean"
