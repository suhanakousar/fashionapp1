# AUTO-GENERATED BY KIRO
# Hook: onFusionComplete Event

event: "onFusionComplete"
trigger: "Fusion job completes successfully"
files_affected:
  - "server/fusionPipeline.ts"
  - "client/src/components/FusionWorkspace.tsx"
  - "client/src/components/ExplainabilityPanel.tsx"

actions:
  - name: "store_results"
    description: "Store fusion results in MongoDB"
    code_location: "server/fusionPipeline.ts:storeResults"
    collection: "FusionJobs"
    fields:
      - "jobId": "string"
      - "imageA": "string (Cloudinary URL)"
      - "imageB": "string (Cloudinary URL)"
      - "resultUrl": "string (Cloudinary URL)"
      - "candidates": "Array of URLs"
      - "metadata": "Object (palette, patterns, explainability)"
      - "createdAt": "Date"
  
  - name: "generate_explainability"
    description: "Generate heatmap and designer notes"
    code_location: "server/fusionPipeline.ts:generateExplainability"
    outputs:
      - "heatmap": "Base64 encoded overlay image"
      - "designerNote": "Auto-generated explanation string"
      - "contributionRegions": "Array of {region, contribution, pattern}"
  
  - name: "upscale_result"
    description: "Upscale final result to 2048x2048px"
    code_location: "server/fusionPipeline.ts:upscaleImage"
    provider: "cloudinary"
    transformation: "q_auto:best,dpr_2.0,w_2048,h_2048"
  
  - name: "notify_client"
    description: "Update UI with results"
    code_location: "client/src/components/FusionWorkspace.tsx:handleFusionComplete"
    state_updates:
      - "resultUrl": "Cloudinary URL"
      - "candidates": "Array of candidate URLs"
      - "explainability": "Object with heatmap and notes"
      - "isComplete": true
  
  - name: "enable_actions"
    description: "Enable Lookbook and Share actions"
    code_location: "client/src/components/FusionWorkspace.tsx"
    actions_enabled:
      - "generateLookbook"
      - "shareToSocial"
      - "tryOnMannequin"
      - "saveToDesigns"

error_handling:
  - error: "Fusion job failed"
    action: "notify_error"
    message: "Fusion failed. Please try again with different images."
    retry: true
  
  - error: "Upscaling failed"
    action: "use_original"
    message: "Upscaling failed, using original resolution."
  
  - error: "Explainability generation failed"
    action: "skip_explainability"
    message: "Explainability unavailable for this fusion."

