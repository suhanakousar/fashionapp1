# Kiro Specification for Fusion Pipeline
# Fashion app virtual try-on feature

name: fusion-pipeline
version: 1.0.0
description: |
  Production-ready fashion virtual try-on pipeline using:
  - SAM (Segment Anything Model) for garment segmentation
  - Stable Diffusion inpainting for fabric application
  - ControlNet for pose/silhouette preservation
  - Face protection for privacy compliance

components:
  backend:
    - server/bytezClient.ts
    - server/cloudinary.ts
    - server/faceProtect.ts
    - server/segmentation.ts
    - server/edge.ts
    - server/fabricFeatures.ts
    - server/postprocess.ts
    - server/mockFusion.ts
    - server/fusionPipelineNew.ts
    - server/routes/fusion.ts

  frontend:
    - client/src/pages/FusionNew.tsx
    - client/src/components/FabricUploader.tsx
    - client/src/components/FusionProgress.tsx
    - client/src/components/FusionResults.tsx
    - client/src/components/TryOnCanvas.tsx

  config:
    - .kiro/spec.yaml
    - .kiro/steering.md
    - .kiro/prompts/fusion_prompt_templates.md

models:
  - name: facebook/sam-vit-base
    provider: Bytez
    purpose: Garment segmentation
    endpoint: SAM segmentation

  - name: stabilityai/stable-diffusion-xl-base-1.0
    provider: Bytez
    purpose: Image-to-image inpainting
    endpoint: SD inpainting

  - name: lllyasviel/control_v11p_sd15_canny
    provider: Bytez
    purpose: Edge detection for ControlNet
    endpoint: Canny edge extraction

  - name: xinntao/Real-ESRGAN
    provider: Bytez
    purpose: Image upscaling
    endpoint: 2x upscaling

  - name: damo/retinaface
    provider: Bytez
    purpose: Face detection
    endpoint: Face detection and masking

environment:
  required:
    - BYTEZ_API_KEY
    - CLOUDINARY_CLOUD_NAME
    - CLOUDINARY_API_KEY
    - CLOUDINARY_API_SECRET
    - DATABASE_URL
    - SESSION_SECRET

  optional:
    - HUGGINGFACE_API_KEY (fallback)
    - REPLICATE_API_TOKEN (fallback)
    - AUTO_MASK_FACES (auto-mask faces if true)

safety:
  face_protection:
    required: true
    consent_required: true
    review_required: true
    locations:
      - server/faceProtect.ts
      - server/fusionPipelineNew.ts (face detection step)

  data_retention:
    ttl_days: 30
    auto_delete: true

  copyright:
    note: "Do not train on copyrighted images without permission"
