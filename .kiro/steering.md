# AUTO-GENERATED BY KIRO
# Steering Guide for Fashion Fusion System

## System Goals

1. **Single Canonical Mannequin**: One mannequin template per garment category to simplify drape mapping
2. **Multi-Fabric Input**: Support top fabric, bottom fabric, and trims/buttons/motif
3. **Reference Model Option**: Allow users to upload reference model dress to preserve structure
4. **Three Generation Modes**: Silhouette-first, texture-first, hybrid
5. **Face Protection**: Never alter faces or identity (REVIEW REQUIRED: masking policy)
6. **Explainability**: Show which fabric parts contributed to which regions

## Pipeline Steps

1. **Load Job Metadata**: Category, fabric URLs, options
2. **Face Detection & Protection**: Detect faces, require consent or auto-mask (REVIEW REQUIRED)
3. **Segmentation (SAM)**: Extract motifs from fabrics, locate garment parts on mannequin
4. **Edge/Silhouette Extraction**: Canny/HED for ControlNet conditioning
5. **Feature Extraction**: Palette, motif patches, CLIP embeddings
6. **Prompt Construction**: Build 3 prompts (one per mode) with fabric descriptions
7. **Image Generation**: Call SD image-to-image with ControlNet, generate 3 candidates
8. **Post-Processing**: Seam blending, color harmonization, Real-ESRGAN upscaling
9. **Explainability**: Compute fabric patch contributions, generate heatmap
10. **Upload & Complete**: Save to Cloudinary, update job status

## Model Selection

- **Face Detection**: Try HuggingFace (damo/retinaface) → Bytez → Cloudinary (fallback)
- **Segmentation**: HuggingFace (facebook/sam-vit-base) → Bytez (fallback)
- **Edge Detection**: Bytez (canny-edge) → Cloudinary (fallback)
- **Image Generation**: HuggingFace (ControlNet + SD) → Replicate → Mock (fallback)
- **Upscaling**: HuggingFace (Real-ESRGAN) → Cloudinary (fallback)
- **Feature Extraction**: HuggingFace (CLIP) → Mock (fallback)

## Safety & Privacy

- **Face Protection**: Always detect faces, require consent or abort (REVIEW REQUIRED)
- **Data Retention**: Delete generated and uploaded files after 30 days unless saved (REVIEW REQUIRED)
- **Consent**: Explicit checkbox for face masking before processing
- **Copyright**: Do not train on copyrighted designer images without permission

## Error Handling

- Retry on failures with exponential backoff (3 attempts)
- Fallback to mock mode if all APIs fail
- Graceful degradation: partial results if some steps fail
- Clear error messages for users

## Performance

- Background processing (non-blocking)
- Progress updates every 5-10%
- Polling interval: 2 seconds
- Timeout: 5 minutes per job
